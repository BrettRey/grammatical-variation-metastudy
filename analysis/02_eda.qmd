---
title: "Exploratory Data Analysis + Model Scaffold"
author: "Brett Reynolds"
date: "2026-01-10"
format:
  html:
    toc: true
    code-fold: true
execute:
  warning: false
  message: false
---

## Setup

```{r}
#| label: setup
library(dplyr)
library(readr)
library(stringr)
library(tidyr)
library(tibble)
library(here)
```

## Load Prepped Data

```{r}
#| label: load-prepped
gramm_var <- read_csv(here("analysis/gramm_var_prepped.csv"))

# Standardize year for modeling
gramm_var <- gramm_var |>
  mutate(
    year_z = as.numeric(scale(year)),
    variation_type_recode = factor(variation_type_recode),
    journal = factor(journal)
  )

# Joint-model outcome: observed only when tested
gramm_var <- gramm_var |>
  mutate(
    tested = as.integer(tested),
    found = as.integer(found),
    foundcond = if_else(tested == 1L, found, NA_integer_)
  )
```

## Basic Counts

```{r}
#| label: counts
gramm_var |>
  count(variation_type_recode, journal)

gramm_var |>
  count(tested)

gramm_var |>
  count(found, tested)
```

## Domain-Specific Testing Rates

```{r}
#| label: domain-rates
tibble(
  domain = c("production", "perception", "metalinguistic"),
  tested = c(sum(gramm_var$prod_tested), sum(gramm_var$perc_tested), sum(gramm_var$meta_tested)),
  found = c(sum(gramm_var$prod_found), sum(gramm_var$perc_found), sum(gramm_var$meta_found))
) |>
  mutate(found_rate = found / tested)
```

## EDA Summary (Snapshot)

```{r}
#| label: eda-summary-values
total_n <- nrow(gramm_var)
tested_n <- sum(gramm_var$tested)
found_n <- sum(gramm_var$found & gramm_var$tested)
tested_rate <- round(100 * tested_n / total_n, 1)
found_rate <- round(100 * found_n / tested_n, 1)

prod_tested <- sum(gramm_var$prod_tested)
prod_found <- sum(gramm_var$prod_found)
perc_tested <- sum(gramm_var$perc_tested)
perc_found <- sum(gramm_var$perc_found)
meta_tested <- sum(gramm_var$meta_tested)
meta_found <- sum(gramm_var$meta_found)

type_counts <- gramm_var |>
  count(variation_type_recode)

tested_rates <- gramm_var |>
  group_by(variation_type_recode) |>
  summarize(rate = round(100 * mean(tested), 1), n = n())

found_rates <- gramm_var |>
  filter(tested == 1L) |>
  group_by(variation_type_recode) |>
  summarize(rate = round(100 * mean(found), 1), tested_n = n())

order_lvc <- gramm_var |>
  filter(variation_type_recode == "order", journal == "LVC") |>
  nrow()
order_jslx <- gramm_var |>
  filter(variation_type_recode == "order", journal == "JSlx") |>
  nrow()

perc_realization <- gramm_var |>
  filter(variation_type_recode == "realization") |>
  summarize(tested = sum(perc_tested), found = sum(perc_found))
```

- Total rows: `r total_n` (note: differs from the expected 426 in project notes).
- Overall testing: `r tested_n` tested (`r tested_rate`%); `r found_n` found among tested (`r found_rate`%).
- Domain coverage is highly imbalanced:
  - Production: `r prod_tested` tested / `r prod_found` found
  - Perception: `r perc_tested` tested / `r perc_found` found (all in realization variables)
  - Metalinguistic: `r meta_tested` tested / `r meta_found` found
- Variation type mix: realization `r type_counts$n[type_counts$variation_type_recode == "realization"]`, order `r type_counts$n[type_counts$variation_type_recode == "order"]`, both `r type_counts$n[type_counts$variation_type_recode == "both"]`.
- Testing rates by type: realization `r tested_rates$rate[tested_rates$variation_type_recode == "realization"]`%, order `r tested_rates$rate[tested_rates$variation_type_recode == "order"]`%, both `r tested_rates$rate[tested_rates$variation_type_recode == "both"]`%.
- Found rates by type (among tested): realization `r found_rates$rate[found_rates$variation_type_recode == "realization"]`%, order `r found_rates$rate[found_rates$variation_type_recode == "order"]`%, both `r found_rates$rate[found_rates$variation_type_recode == "both"]`%.
- Journal confound: order variables are almost entirely LVC (`r order_lvc` LVC vs `r order_jslx` JSlx).
- Interpretation note: most of the variation appears in **selection (tested vs not)** rather than in outcomes once tested.

## Prior Sensitivity: Agnostic vs Data-Centered

```{r}
#| label: prior-sensitivity
#| eval: true
library(brms)

# Empirical baselines for data-centered intercepts (sensitivity check)
logit <- function(p) log(p / (1 - p))
p_tested <- mean(gramm_var$tested)
p_found <- mean(gramm_var$found[gramm_var$tested == 1L])

priors_agnostic <- c(
  set_prior("normal(0, 1.2)", class = "Intercept", resp = "tested"),
  set_prior("normal(0, 1.2)", class = "Intercept", resp = "foundcond"),
  set_prior("normal(0, 0.7)", class = "b", resp = "tested"),
  set_prior("normal(0, 0.7)", class = "b", resp = "foundcond"),
  set_prior("exponential(2)", class = "sd", resp = "tested"),
  set_prior("exponential(2)", class = "sd", resp = "foundcond")
)

priors_centered <- c(
  set_prior(paste0("normal(", round(logit(p_tested), 3), ", 0.7)"), class = "Intercept", resp = "tested"),
  set_prior(paste0("normal(", round(logit(p_found), 3), ", 0.7)"), class = "Intercept", resp = "foundcond"),
  set_prior("normal(0, 0.7)", class = "b", resp = "tested"),
  set_prior("normal(0, 0.7)", class = "b", resp = "foundcond"),
  set_prior("exponential(2)", class = "sd", resp = "tested"),
  set_prior("exponential(2)", class = "sd", resp = "foundcond")
)

bf_tested <- bf(
  tested ~ 1 + variation_type_recode + journal + year_z +
    (1 | paper_id) + (1 | author_id) + (1 | language_id)
)

bf_found <- bf(
  foundcond ~ 1 + variation_type_recode + journal + year_z +
    (1 | paper_id) + (1 | author_id) + (1 | language_id)
)

fit_prior_agnostic <- brm(
  bf_tested + bf_found + set_rescor(FALSE),
  data = gramm_var,
  family = bernoulli(),
  prior = priors_agnostic,
  sample_prior = "only",
  chains = 2, iter = 1000, warmup = 500, cores = 2, seed = 123
)

fit_prior_centered <- brm(
  bf_tested + bf_found + set_rescor(FALSE),
  data = gramm_var,
  family = bernoulli(),
  prior = priors_centered,
  sample_prior = "only",
  chains = 2, iter = 1000, warmup = 500, cores = 2, seed = 123
)

pp_check(fit_prior_agnostic, resp = "tested")
pp_check(fit_prior_agnostic, resp = "foundcond")
pp_check(fit_prior_centered, resp = "tested")
pp_check(fit_prior_centered, resp = "foundcond")

summarize_prior_rates <- function(fit, resp) {
  ep <- posterior_epred(fit, resp = resp)
  rates <- rowMeans(ep)
  quantile(rates, c(0.05, 0.5, 0.95))
}

tibble(
  prior = c("agnostic", "agnostic", "centered", "centered"),
  response = c("tested", "foundcond", "tested", "foundcond"),
  q05 = c(
    summarize_prior_rates(fit_prior_agnostic, "tested")[1],
    summarize_prior_rates(fit_prior_agnostic, "foundcond")[1],
    summarize_prior_rates(fit_prior_centered, "tested")[1],
    summarize_prior_rates(fit_prior_centered, "foundcond")[1]
  ),
  q50 = c(
    summarize_prior_rates(fit_prior_agnostic, "tested")[2],
    summarize_prior_rates(fit_prior_agnostic, "foundcond")[2],
    summarize_prior_rates(fit_prior_centered, "tested")[2],
    summarize_prior_rates(fit_prior_centered, "foundcond")[2]
  ),
  q95 = c(
    summarize_prior_rates(fit_prior_agnostic, "tested")[3],
    summarize_prior_rates(fit_prior_agnostic, "foundcond")[3],
    summarize_prior_rates(fit_prior_centered, "tested")[3],
    summarize_prior_rates(fit_prior_centered, "foundcond")[3]
  )
)
```

## Joint Models by Domain (Scaffold)

```{r}
#| label: domain-model-scaffold
#| eval: false
fit_domain <- function(data, tested_var, found_var) {
  data <- data |>
    mutate(
      tested_d = as.integer(.data[[tested_var]]),
      found_d = as.integer(.data[[found_var]]),
      foundcond_d = if_else(tested_d == 1L, found_d, NA_integer_)
    )

  bf_tested <- bf(
    tested_d ~ 1 + variation_type_recode + journal + year_z +
      (1 | paper_id) + (1 | author_id) + (1 | language_id)
  )

  bf_found <- bf(
    foundcond_d ~ 1 + variation_type_recode + journal + year_z +
      (1 | paper_id) + (1 | author_id) + (1 | language_id)
  )

  priors_d <- c(
    set_prior("normal(0, 1.2)", class = "Intercept", resp = "tested_d"),
    set_prior("normal(0, 1.2)", class = "Intercept", resp = "foundcond_d"),
    set_prior("normal(0, 0.7)", class = "b", resp = "tested_d"),
    set_prior("normal(0, 0.7)", class = "b", resp = "foundcond_d"),
    set_prior("exponential(2)", class = "sd", resp = "tested_d"),
    set_prior("exponential(2)", class = "sd", resp = "foundcond_d")
  )

  brm(
    bf_tested + bf_found + set_rescor(FALSE),
    data = data,
    family = bernoulli(),
    prior = priors_d,
    chains = 2, iter = 2000, warmup = 1000, cores = 2, seed = 123
  )
}

# Example (run one at a time):
# fit_prod <- fit_domain(gramm_var, "prod_tested", "prod_found")
```
